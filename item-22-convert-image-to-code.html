<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;

         var fps = 25;
         var ANIMATION;

         // http://www.williammalone.com/articles/create-html5-canvas-javascript-sprite-animation/
         var animImages = [];
         for ( var i = 0; i < 8; ++i ) {
            var animImage = new Image();
            animImage.src = "avatar-"+i+".png";
            animImages.push(animImage);
         }
         var phase = 0;

         var imgdata1 = {
            blacks:[23,10,24,10,25,10,26,10,27,10,28,10,21,11,22,11,29,11,30,11,20,12,31,12,19,13,32,13,18,14,32,14,18,15,33,15,18,16,33,16,18,17,33,17,18,18,19,18,33,18,18,19,19,19,25,19,26,19,27,19,33,19,18,20,19,20,25,20,26,20,27,20,33,20,18,21,25,21,26,21,27,21,32,21,18,22,32,22,18,23,32,23,19,24,22,24,23,24,32,24,19,25,31,25,20,26,31,26,21,27,30,27,21,28,22,28,23,28,24,28,30,28,31,28,32,28,20,29,33,29,20,30,34,30,19,31,35,31,19,32,35,32,19,33,36,33,19,34,36,34,18,35,36,35,18,36,33,36,37,36,18,37,33,37,37,37,18,38,33,38,34,38,37,38,18,39,33,39,34,39,37,39,18,40,33,40,34,40,38,40,18,41,33,41,34,41,38,41,17,42,33,42,35,42,38,42,17,43,33,43,35,43,38,43,17,44,32,44,35,44,38,44,17,45,19,45,32,45,35,45,39,45,17,46,19,46,32,46,35,46,39,46,17,47,19,47,32,47,35,47,39,47,16,48,19,48,32,48,35,48,39,48,16,49,19,49,32,49,35,49,39,49,16,50,19,50,32,50,35,50,39,50,16,51,19,51,32,51,35,51,39,51,16,52,19,52,32,52,34,52,39,52,15,53,19,53,32,53,34,53,39,53,15,54,19,54,32,54,34,54,39,54,15,55,19,55,32,55,34,55,39,55,14,56,16,56,19,56,32,56,33,56,39,56,14,57,16,57,19,57,23,57,24,57,25,57,26,57,31,57,33,57,39,57,14,58,19,58,23,58,26,58,31,58,33,58,38,58,14,59,19,59,23,59,26,59,31,59,33,59,38,59,15,60,18,60,19,60,23,60,26,60,31,60,32,60,38,60,16,61,17,61,19,61,23,61,26,61,31,61,32,61,38,61,19,62,23,62,26,62,31,62,33,62,37,62,19,63,23,63,26,63,31,63,33,63,37,63,19,64,23,64,26,64,31,64,33,64,36,64,19,65,23,65,27,65,31,65,33,65,34,65,35,65,19,66,23,66,27,66,31,66,19,67,23,67,27,67,31,67,32,67,33,67,34,67,19,68,23,68,27,68,31,68,35,68,19,69,23,69,27,69,31,69,35,69,19,70,23,70,24,70,25,70,26,70,27,70,31,70,36,70,19,71,23,71,28,71,32,71,33,71,37,71,19,72,28,72,32,72,34,72,35,72,38,72,19,73,26,73,27,73,28,73,32,73,36,73,37,73,19,74,24,74,25,74,28,74,32,74,20,75,21,75,22,75,23,75,28,75,32,75,28,76,32,76,29,77,32,77,29,78,33,78,29,79,33,79,29,80,33,80,29,81,33,81,30,82,33,82,30,83,34,83,30,84,34,84,30,85,34,85,30,86,34,86,29,87,35,87,28,88,35,88,28,89,27,90,27,91],
            yellows:[28,11,6,30,12,10,31,13,12,31,14,13,32,15,14,32,16,14,32,17,14,32,18,13,24,19,5,32,19,5,24,20,5,32,20,5,24,21,6,31,21,4,31,22,13,31,23,13,21,24,2,31,24,8,30,25,11,30,26,10,29,27,8,29,28,5,28,29,6,27,30,5,33,30,1,26,31,3,34,31,3,25,32,2,34,32,3,35,33,4,35,34,3,19,35,1,35,35,3,19,36,1,36,36,3,19,37,1,36,37,3,19,38,1,36,38,2,19,39,1,36,39,2,19,40,1,37,40,3,19,41,1,37,41,3,19,42,2,37,42,2,19,43,2,37,43,2,19,44,2,37,44,2,18,45,1,38,45,3,18,46,1,38,46,3,18,47,1,38,47,3,18,48,2,38,48,3,18,49,2,38,49,3,18,50,2,38,50,3,18,51,2,38,51,3,18,52,2,38,52,4,18,53,3,38,53,4,18,54,3,38,54,4,18,55,3,38,55,4,15,56,1,18,56,2,38,56,5,15,57,1,18,57,2,38,57,5,18,58,4,37,58,4,18,59,4,37,59,4,17,60,2,37,60,5,37,61,5,36,62,3,36,63,3,35,64,2],
            reds:[22,29,2,32,29,4,22,30,2,32,30,5,23,31,4,31,31,5,23,32,4,31,32,6,31,33,12,32,34,13,32,35,13,32,36,13,32,37,13,32,38,13,32,39,13,32,40,13,32,41,13,32,42,13,32,43,13,31,44,12,31,45,12,31,46,12,31,47,12,31,48,12,31,49,12,31,50,12,31,51,12,31,52,12,31,53,12,31,54,12,31,55,12,31,56,12,22,57,3,30,57,4,22,58,3,30,58,4,22,59,3,30,59,4,22,60,3,30,60,4,22,61,3,30,61,4,22,62,3,30,62,4,22,63,3,30,63,4,22,64,3,30,64,4,22,65,3,30,65,3,22,66,3,30,66,3,22,67,3,30,67,3,22,68,3,30,68,3,34,68,3,22,69,3,30,69,3,34,69,3,22,70,3,30,70,3,35,70,4,22,71,3,27,71,4,31,71,3,36,71,3,27,72,8,31,72,3,37,72,2,25,73,6,31,73,3,23,74,4,31,74,3,31,75,3,31,76,3,31,77,2,32,78,3,32,79,3,32,80,3,32,81,3,32,82,2,33,83,3,33,84,3,33,85,3,33,86,3,34,87,5,34,88,6,33,89,5,31,90,4,28,91,1]
         };

         function drawRImage(rimage, ux, uy, ds) {
            for ( var i = 0; i < rimage.yellows.length; ++i ) {
                var item = rimage.yellows[i];
                var dx = item[0];
                var dy = item[1];
                var len = item[2];
                context.fillStyle = "yellow";
                context.fillRect(ux+(dx-len+1)*ds,uy+dy*ds,ds*len,ds);
            }
            for ( var i = 0; i < rimage.reds.length; ++i ) {
                var item = rimage.reds[i];
                var dx = item[0];
                var dy = item[1];
                var len = item[2];
                context.fillStyle = "red";
                context.fillRect(ux+(dx-len+1)*ds,uy+dy*ds,ds*len,ds);
            }
            for ( var i = 0; i < rimage.blacks.length; ++i ) {
                var item = rimage.blacks[i];
                var dx = item[0];
                var dy = item[1];
                context.fillStyle = "black";
                context.fillRect(ux+dx*ds,uy+dy*ds,ds,ds);
            }
         }

         function drawRImage2(rimage, ux, uy, ds) {
            for ( var i = 0; i < rimage.yellows.length/3; ++i ) {
                var dx  = rimage.yellows[i*3+0];
                var dy  = rimage.yellows[i*3+1];
                var len = rimage.yellows[i*3+2];
                context.fillStyle = "yellow";
                context.fillRect(ux+(dx-len+1)*ds,uy+dy*ds,ds*len,ds);
            }
            for ( var i = 0; i < rimage.reds.length/3; ++i ) {
                var dx  = rimage.reds[i*3+0];
                var dy  = rimage.reds[i*3+1];
                var len = rimage.reds[i*3+2];
                context.fillStyle = "red";
                context.fillRect(ux+(dx-len+1)*ds,uy+dy*ds,ds*len,ds);
            }
            for ( var i = 0; i < rimage.blacks.length/2; ++i ) {
                var dx = rimage.blacks[i*2+0];
                var dy = rimage.blacks[i*2+1];
                context.fillStyle = "black";
                context.fillRect(ux+dx*ds,uy+dy*ds,ds,ds);
            }
         }

         var printed = 0;
         function drawBackground() {
            context.fillStyle = "green";
            context.fillRect(0,0,screenWidth,screenHeight);
            context.drawImage(animImages[phase],0,0,500,280);

            context.beginPath();
            context.lineWidth = "1";
            context.strokeStyle = "darkgreen";
            var gridx = 54.5;
            var gridy = 122;
            var shx = 29;
            var shy = 25;
            var areax = 54;
            var areay = 100;
            for ( var x = 0; x < 8; ++x ) {
               for ( var y = 0; y < 2; ++y ) {
                  context.rect(shx+Math.floor(gridx*x),shy+gridy*y,areax,areay);
               }
            }
            context.stroke();
            var ix = 1;
            var iy = 1;
            var cntr = 0;
            var rude = 1;
            var rimage = { blacks:[], reds:[], yellows:[] };
            for ( var dy = 0; dy < areay; ++dy ) {
                for ( var dx = 0; dx < areax; ++dx ) {
                  var dat = context.getImageData(shx+dx+Math.floor(ix*gridx),shy+iy*gridy+dy,1,1);
                  if ( !dat.data[0] && !dat.data[1] && !dat.data[2] ) {
                     // black
                     rimage.blacks.push([dx,dy]);
                     ++cntr;
                  } else if ( dat.data[0] && !dat.data[1] && !dat.data[2] ) {
                     // red
                     var cdid = [dx,dy,1];
                     if ( rimage.reds.length && rimage.reds[rimage.reds.length-1][0] == dx-1 && rimage.reds[rimage.reds.length-1][1] == dy ) {
                        var lst = rimage.reds[rimage.reds.length-1];
                        rimage.reds[rimage.reds.length-1] = [dx,dy,lst[2]+1];
                     } else {
                        rimage.reds.push(cdid);
                     }
                  } else if ( !(!dat.data[0] && dat.data[1] && !dat.data[2]) ) {
                     // yellow
                     var cdid = [dx,dy,1];
                     if ( rimage.yellows.length && rimage.yellows[rimage.yellows.length-1][0] == dx-1 && rimage.yellows[rimage.yellows.length-1][1] == dy ) {
                        var lst = rimage.yellows[rimage.yellows.length-1];
                        rimage.yellows[rimage.yellows.length-1] = [dx,dy,lst[2]+1];
                     } else {
                        rimage.yellows.push(cdid);
                     }

                  }
               }
            }

            drawRImage(rimage,500,100,5);
            drawRImage2(imgdata1,800,100,5);
            if ( !printed ) {
               printed = 1;
               console.log('blacks:[',rimage.blacks.toString(),']');
               console.log('yellows:[',rimage.yellows.toString(),']');
               console.log('reds:[',rimage.reds.toString(),']');
            }

            phase = (phase + 1)%8;
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / fps );
         }

         function initCanvas() {
            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
         })();
      </script>
   </body>
</html>
