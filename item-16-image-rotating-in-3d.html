<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;

         var fps = 25;
         var ANIMATION;

         var myImage = new Image();
         myImage.src = "item-16-image.png";

         var texture = {x:0,y:0,dx:400,dy:400};

         var triangle = [{x:200,y:100},{x:800,y:200},{x:250,y:500}];

         function drawWireframeTriangle( vertices ) {
            context.strokeStyle = "lightblue";
            context.beginPath();
            if ( vertices.length >= 3 ) {
               context.moveTo( vertices[0].x, vertices[0].y );
            }
            context.lineTo( vertices[1].x, vertices[1].y );
            context.lineTo( vertices[2].x, vertices[2].y );
            context.closePath();
            context.stroke();
         }

         var dist = 1.0;
         function projection( vertex3d ) {
            var dx = ( vertex3d.x * dist ) / vertex3d.z;
            var dy = ( vertex3d.y * dist ) / vertex3d.z;
            return { x: screenWidth / 2 + screenScale * dx, y : screenHeight / 2 + screenScale * dy };
         }

         function drawPictureIn3D( vertices3d, image, image_dimensions ) {
            if ( vertices3d.length < 4 ) {
               return;
            }
            var vertices = [ projection( vertices3d[0] ),
                             projection( vertices3d[1] ),
                             projection( vertices3d[2] ),
                             projection( vertices3d[3] ) ];

            drawTexturedTriangle( [ vertices[0], vertices[1], vertices[3] ], image, {x:0, y:0, dx:400, dy:400} );
            drawTexturedTriangle( [ vertices[2], vertices[3], vertices[1] ], image, {x:400, y:400, dx:-400, dy:-400} );

            drawWireframeTriangle( [ vertices[0], vertices[1], vertices[3] ] );
            drawWireframeTriangle( [ vertices[2], vertices[3], vertices[1] ] );
         }

         // http://stackoverflow.com/questions/21299439/clipping-images-into-different-shapes-like-triangle-pentagon-in-html5-canvas
         function drawTexturedTriangle( vertices, image, texdescriptor ) {
            var tan1 = ( vertices[1].x == vertices[0].x ) ? ( vertices[1].y - vertices[0].y ) :  ( vertices[1].y - vertices[0].y ) / ( vertices[1].x - vertices[0].x );
            var rat1 = ( vertices[1].x - vertices[0].x ) / texdescriptor.dx;
            var tan2 = ( vertices[2].y == vertices[0].y ) ? ( vertices[2].x - vertices[0].x ) :  ( vertices[2].x - vertices[0].x ) / ( vertices[2].y - vertices[0].y );
            var rat2 = ( vertices[2].y - vertices[0].y ) / texdescriptor.dy;
            context.save();
            context.setTransform( rat1,          // horizontal scaling
                                  tan1 * rat1,   // horizontal skewing
                                  tan2 * rat2,   // vertical skewing
                                  rat2,          // vertical scaling
                                  vertices[0].x, // horizontal moving
                                  vertices[0].y);// vertical moving
            context.translate(-texdescriptor.x,-texdescriptor.y);
            context.save();
            context.beginPath();
            context.moveTo(texdescriptor.x,texdescriptor.y);
            context.lineTo(texdescriptor.x + texdescriptor.dx, texdescriptor.y);
            context.lineTo(texdescriptor.x          , texdescriptor.y + texdescriptor.dy);
            context.closePath();
            context.restore();

            context.clip();
            context.drawImage(image, 0, 0);
            context.restore();
         }

         function drawBackground() {
            context.fillStyle = "black";
            context.fillRect(0,0,screenWidth,screenHeight);

            var vertices = [{x:-50,y:-50, z:100},
                            {x: 50,y:-50, z:100},
                            {x: 50,y: 50, z:100},
                            {x:-50,y: 50, z:100}];
            drawPictureIn3D( vertices, myImage );
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / fps );
         }

         function initCanvas() {
            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
         })();
      </script>
   </body>
</html>
