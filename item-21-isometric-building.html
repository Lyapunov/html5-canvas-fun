<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;

         var fps = 25;
         var ANIMATION;

         var levelMapEven= [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,4,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,4,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,4,0,4,0,0,0,0,1,4,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,1,0,4,0,1,0,1,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,6,0,1,0,5,0,1,4,1,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,0,1,4,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,4,1,1,4,1,1,1,1,1,1,1,1,4,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

         var levelMapOdd = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

         var cameraCenter = [15.5,15.5];
         var tileSize = 50;

         function drawBackground() {
            context.fillStyle = "black";
            context.fillRect(0,0,screenWidth,screenHeight);
         }

         function drawFloor(y,x, color) {
            context.fillStyle = color;
            context.beginPath();
            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;
            context.moveTo( px, py - tileSize );
            context.lineTo( px + Math.sqrt(3) * tileSize, py );
            context.lineTo( px, py + tileSize );
            context.lineTo( px - Math.sqrt(3) * tileSize, py );
            context.closePath();
            context.fill();
         }

         function drawWall(y,x,num, color) {
            /*         x      x
                      /|\    / \
                     x0|1x  x   x
                1    | x |  |\ /|
               / \   |/ \|  |2x3|
              4 o 2  x   x  x | x
               \ /    \ /    \|/
                3      x      x
            */

            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;

            switch (num) {
               case 0:
                  {
                     context.fillStyle = color;
                     context.beginPath();
                     context.moveTo( px, py - tileSize );
                     context.lineTo( px - Math.sqrt(3) * tileSize, py );
                     context.lineTo( px - Math.sqrt(3) * tileSize, py - 2 * tileSize );
                     context.lineTo( px, py - 3 * tileSize );
                  }
                  break;
               case 1:
                  {
                     context.fillStyle = color;
                     context.beginPath();
                     context.moveTo( px, py - tileSize );
                     context.lineTo( px + Math.sqrt(3) * tileSize, py );
                     context.lineTo( px + Math.sqrt(3) * tileSize, py - 2 * tileSize );
                     context.lineTo( px, py - 3 * tileSize );
                  }
                  break;
               case 2:
                  {
                     context.globalAlpha = 0.75;
                     context.fillStyle = "#000000";
                     context.beginPath();
                     context.moveTo( px, py + tileSize );
                     context.lineTo( px - Math.sqrt(3) * tileSize, py );
                     context.lineTo( px - Math.sqrt(3) * tileSize, py - 2 * tileSize );
                     context.lineTo( px, py - tileSize );
                  }
                  break;
               case 3:
                  {
                     context.globalAlpha = 0.75;
                     context.fillStyle = "#000000";
                     context.beginPath();
                     context.moveTo( px, py + tileSize );
                     context.lineTo( px + Math.sqrt(3) * tileSize, py );
                     context.lineTo( px + Math.sqrt(3) * tileSize, py - 2 * tileSize );
                     context.lineTo( px, py - tileSize );
                  }
                  break;
               default:
                  {
                     throw "Ooops";
                  }
                  break;
            }
            context.closePath();
            context.fill();
            context.globalAlpha = 1.0;
         }

         function getMapCell(y,x) {
            if ( y < levelMapEven.length && y >= 0 && x < levelMapEven[y].length && x >= 0 ) {
               return levelMapEven[y][x];
            }
            return 0;
         }

         function isMapCellVisible(y,x,cy,cx,oy,ox,sx=0.5+ox,sy=0.5+oy,debug=0) {
            var dirY  = y - oy;
            var dirX  = x - ox;
            var dirL  = Math.hypot(dirX,dirY);
            dirY /= dirL;
            dirX /= dirL;

            var celly = cy;
            var cellx = cx;

            var dist  = 0;
            var arrived = 0;
            var limit = 50;
            var err = 1e-6;
            if ( debug ) {
               console.log( [cy,cx], " -> ", [cy+y,cx+x] ); 
            }

            while ( limit && getMapCell( celly, cellx ) != 0 && !( celly == cy + y && cellx == cx + x ) ) {
               if ( debug ) {
                  console.log( limit + " - " + celly + ", " + cellx + " [" + sy + ", " + sx + "] dir:" + dirY + ", " + dirX); 
               }

               --limit;
               var jump  = Math.min( Math.max( ( 1 - sx ) / dirX, -sx / dirX ),
                                     Math.max( ( 1 - sy ) / dirY, -sy / dirY ) );
               dist += jump;
               sx = sx + dirX * jump;
               sy = sy + dirY * jump;
               if ( Math.abs(sx) < err && dirX < 0) {
                  sx = 1;
                  cellx -= 1;
                  arrived = 1;
               } else if ( Math.abs(1-sx) < err && dirX > 0 ) {
                  sx = 0;
                  cellx += 1;
                  arrived = 2;
               }
               if ( Math.abs(sy) < err && dirY < 0 ) {
                  sy = 1;
                  celly -= 1;
                  arrived = 3;
               } else if ( Math.abs(1-sy) < err && dirY > 0 ) {
                  sy = 0;
                  celly += 1;
                  arrived = 4;
               }
            }

            if ( debug ) {
               console.log( limit + " - " + celly + ", " + cellx + " [" + sy + ", " + sx + "] dir:" + dirY + ", " + dirX); 
            }
            return ( celly == cy + y && cellx == cx + x );
         }

         function drawCellFloor(y,x,cy,cx,oy,ox) {
            drawFloor(-y+oy,x-ox, "gray");
         }

         function drawCellWall(y,x,cy,cx,oy,ox) {
            if ( !getMapCell(cy+y,cx+x-1) ) {
               drawWall(-y+oy,x-ox,0, "blue");
            }
            if ( !getMapCell(cy+y-1,cx+x) ) {
               drawWall(-y+oy,x-ox,1, "blue");
            }

            if ( !getMapCell(cy+y+1,cx+x) ) {
               drawWall(-y+oy,x-ox,2, "blue");
            }
            if ( !getMapCell(cy+y,cx+x+1) ) {
               drawWall(-y+oy,x-ox,3, "blue");
            }
         }


         function drawForeground() {
            var cy = Math.floor(cameraCenter[0]);
            var cx = Math.floor(cameraCenter[1]);
            var oy = cameraCenter[0] - cy - 0.5;
            var ox = cameraCenter[1] - cx - 0.5;

            var cellsy = [];
            var cellsx = [];

            for ( var y = -10; y < 10; ++y ) {
               for ( var x = -10; x < 10; ++x ) {
                  if ( isMapCellVisible(y,x,cy,cx,oy,ox) 
                       || isMapCellVisible(y,x,cy,cx,oy,ox,0,0) 
                       || isMapCellVisible(y,x,cy,cx,oy,ox,0,1) 
                       || isMapCellVisible(y,x,cy,cx,oy,ox,1,0) 
                       || isMapCellVisible(y,x,cy,cx,oy,ox,1,1) )
                  {
                     if ( getMapCell(cy+y,cx+x) ) {
                        cellsy.push(y);
                        cellsx.push(x);
                     }
                  }
               }
            }

            {
               for ( var i = 0; i < cellsx.length; ++i ) {
                  drawCellFloor(cellsy[i],cellsx[i],cy,cx,oy,ox);
               }
            }

            {
               for ( var i = 0; i < cellsx.length; ++i ) {
                  drawCellWall(cellsy[i],cellsx[i],cy,cx,oy,ox);
               }
            }
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               drawForeground();
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / fps );
         }

         function initCanvas() {
            console.log(isMapCellVisible(1,-2,12,15,0,0,1));

            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         function keyHandlerDown(e) {
           console.log(e.keyCode);
           switch( e.keyCode ) {
              case 37:
                 // left
                 cameraCenter[1]-= 0.1;
                 break;
              case 39:
                 // right
                 cameraCenter[1]+= 0.1;
                 break;
              case 38:
                 // up
                 cameraCenter[0]-= 0.1;
                 break;
              case 40:
                 // up
                 cameraCenter[0]+= 0.1;
                 break;
           }
         }

         function keyHandlerUp(e) {
           switch( e.keyCode ) {
              case 37:
                 // left
                 break;
              case 39:
                 // right
                 break;
              case 38:
                 break;
           }
         }

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
            addEventListener('keydown',keyHandlerDown,false);
            addEventListener('keyup'  ,keyHandlerUp,false);
         })();
      </script>
   </body>
</html>
