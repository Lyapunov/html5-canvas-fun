<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;

         var fps = 25;
         var ANIMATION;

         var levelMap = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,4,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,4,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,4,0,4,0,0,0,0,1,4,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,0,4,0,1,0,1,0,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,0,1,0,3,0,1,4,1,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,0,0,0,2,0,1,0,1,4,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,4,1,1,4,1,1,1,1,1,1,1,1,4,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                         ];

         var cameraCenter = [15.5,15.5];
         var tileSize = 50;

         function drawBackground() {
            context.fillStyle = "black";
            context.fillRect(0,0,screenWidth,screenHeight);
         }

         function drawTile(y,x) {
            context.fillStyle = "blue";
            context.beginPath();
            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;
            context.moveTo( px, py - tileSize );
            context.lineTo( px + Math.sqrt(3) * tileSize, py );
            context.lineTo( px, py + tileSize );
            context.lineTo( px - Math.sqrt(3) * tileSize, py );
            context.closePath();
            context.fill();
         }

         function getMapCell(y,x) {
            if ( y < levelMap.length && y >= 0 && x < levelMap[y].length && x >= 0 ) {
               return levelMap[y][x];
            }
            return 0;
         }

         function drawFloor(y,x,cy,cx,oy,ox) {
            if ( getMapCell(cy+y,cx+x) ) {
               drawTile(-y+oy,x-ox);
            }
         }

         function drawForeground() {
            var cy = Math.floor(cameraCenter[0]);
            var cx = Math.floor(cameraCenter[1]);
            var offy = cameraCenter[0] - cy - 0.5;
            var offx = cameraCenter[1] - cx - 0.5;

            drawFloor(0,0,cy,cx,offy,offx);
            for ( var rad = 1; rad < 5; ++rad ) {
               for ( var pos = -rad; pos < rad; ++pos ) {
                  drawFloor(  rad,  pos,cy,cx,offy,offx);
                  drawFloor(1+pos,  rad,cy,cx,offy,offx);
                  drawFloor(  pos, -rad,cy,cx,offy,offx);
                  drawFloor( -rad,1+pos,cy,cx,offy,offx);
               }
            }
//            cameraCenter[0]+= 0.1;
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               drawForeground();
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / fps );
         }

         function initCanvas() {
            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         function keyHandlerDown(e) {
           console.log(e.keyCode);
           switch( e.keyCode ) {
              case 37:
                 // left
                 cameraCenter[1]-= 0.1;
                 break;
              case 39:
                 // right
                 cameraCenter[1]+= 0.1;
                 break;
              case 38:
                 // up
                 cameraCenter[0]-= 0.1;
                 break;
              case 40:
                 // up
                 cameraCenter[0]+= 0.1;
                 break;
           }
         }

         function keyHandlerUp(e) {
           switch( e.keyCode ) {
              case 37:
                 // left
                 break;
              case 39:
                 // right
                 break;
              case 38:
                 break;
           }
         }

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
            addEventListener('keydown',keyHandlerDown,false);
            addEventListener('keyup'  ,keyHandlerUp,false);
         })();
      </script>
   </body>
</html>
