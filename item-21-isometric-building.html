<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
            cursor : none;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;

         var fps = 25;
         var ANIMATION;

         var curX = 0;
         var curY = 0;
         var curTarg = 0;
         var figureWay = [];

         var levelMapEven= [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,4,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,4,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,4,0,4,0,0,0,0,1,4,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,1,0,4,0,1,0,1,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,6,0,1,0,5,0,1,4,1,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,0,1,4,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,4,1,1,4,1,1,1,1,1,1,1,1,4,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

         var levelMapOdd = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

         var levelMapLast= [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,4,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,4,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,4,0,4,0,0,0,0,1,4,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,1,1,1,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,4,0,1,0,1,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,1,0,5,0,1,4,1,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,0,1,4,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                            [0,0,1,1,1,1,1,1,4,1,1,4,1,1,1,1,1,1,1,1,4,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                            [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

         var levelMap = [levelMapEven,levelMapOdd,levelMapEven,levelMapOdd,levelMapEven,levelMapOdd,levelMapEven,levelMapOdd,levelMapEven,levelMapOdd,levelMapLast];

         var figurePosition  = [15.5,15.5,6];
         var tileSize = 50;

         function drawBackground() {
            context.fillStyle = "black";
            context.fillRect(0,0,screenWidth,screenHeight);
         }

         function drawFloor(y,x, color) {
            context.fillStyle = color;
            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;
            context.beginPath();
            context.moveTo( px, py - tileSize );
            context.lineTo( px + Math.sqrt(3) * tileSize, py );
            context.lineTo( px, py + tileSize );
            context.lineTo( px - Math.sqrt(3) * tileSize, py );
            context.closePath();
            context.fill();
         }

         function drawTile(tile,color) {
            if ( tile !== undefined ) {
               context.strokeStyle = color;
               context.beginPath();
               context.moveTo( tile.p1.x, tile.p1.y );
               context.lineTo( tile.p2.x, tile.p2.y );
               context.lineTo( tile.p3.x, tile.p3.y );
               context.lineTo( tile.p4.x, tile.p4.y );
               context.closePath();
               context.stroke();
            }
         }

         function getFloorTile(y,x,obi) {
            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;
            obi.p1 = {x:px,y:py-tileSize};
            obi.p2 = {x:px + Math.sqrt(3) * tileSize,y:py};
            obi.p3 = {x:px,y:py+tileSize};
            obi.p4 = {x:px - Math.sqrt(3) * tileSize,y:py};
            return obi;
         }

         function drawItem(y,x,color, shifts=1.0) {
            context.fillStyle = color;
            context.beginPath();
            var radius = tileSize / 2;
            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;
            context.moveTo( px - radius, py - 4* radius * shifts );
            context.lineTo( px + radius, py - 4* radius * shifts );
            context.lineTo( px + radius, py );
            context.lineTo( px - radius, py );
            context.closePath();
            context.fill();
         }

         function drawCursor(x,y) {
            context.fillStyle = "red";
            context.beginPath();
            context.moveTo( x, y );
            context.lineTo( x+15, y+20 );
            context.lineTo( x, y+25 );
            context.closePath();
            context.fill();
         }

         function drawStairs(y,x,color,num) {
            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;

            if ( num == 0 ) {
               context.fillStyle = color;
               context.beginPath();
               context.moveTo( px, py - tileSize - 2* tileSize );
               context.lineTo( px + Math.sqrt(3) * tileSize, py - 2* tileSize );
               context.lineTo( px, py + tileSize );
               context.lineTo( px - Math.sqrt(3) * tileSize, py );
               context.closePath();
               context.fill();
             
               context.fillStyle = "black";
               context.beginPath();
               context.moveTo( px + Math.sqrt(3) * tileSize, py );
               context.lineTo( px + Math.sqrt(3) * tileSize, py - 2* tileSize );
               context.lineTo( px, py + tileSize );
               context.closePath();
               context.fill();
            } 
            
            if ( num == 1 ) {
               context.fillStyle = "black";
               context.beginPath();
               context.moveTo( px, py + tileSize );
               context.lineTo( px - Math.sqrt(3) * tileSize, py );
               context.lineTo( px - Math.sqrt(3) * tileSize, py - 2 * tileSize );
               context.lineTo( px, py - tileSize );
               context.closePath();
               context.fill();

               context.fillStyle = "black";
               context.beginPath();
               context.moveTo( px + Math.sqrt(3) * tileSize, py );
               context.lineTo( px, py + tileSize );
               context.lineTo( px, py - tileSize );

               context.closePath();
               context.fill();
            }
         }

         function drawWall(y,x,num, color) {
            /*         x      x
                      /|\    / \
                     x0|1x  x   x
                1    | x |  |\ /|
               / \   |/ \|  |2x3|
              4 o 2  x   x  x | x
               \ /    \ /    \|/
                3      x      x
            */

            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;

            switch (num) {
               case 0:
                  {
                     context.fillStyle = color;
                     context.beginPath();
                     context.moveTo( px, py - tileSize );
                     context.lineTo( px - Math.sqrt(3) * tileSize, py );
                     context.lineTo( px - Math.sqrt(3) * tileSize, py - 2 * tileSize );
                     context.lineTo( px, py - 3 * tileSize );
                  }
                  break;
               case 1:
                  {
                     context.fillStyle = color;
                     context.beginPath();
                     context.moveTo( px, py - tileSize );
                     context.lineTo( px + Math.sqrt(3) * tileSize, py );
                     context.lineTo( px + Math.sqrt(3) * tileSize, py - 2 * tileSize );
                     context.lineTo( px, py - 3 * tileSize );
                  }
                  break;
               case 2:
                  {
                     context.globalAlpha = 0.75;
                     context.fillStyle = "#000000";
                     context.beginPath();
                     context.moveTo( px, py + tileSize );
                     context.lineTo( px - Math.sqrt(3) * tileSize, py );
                     context.lineTo( px - Math.sqrt(3) * tileSize, py - 2 * tileSize );
                     context.lineTo( px, py - tileSize );
                  }
                  break;
               case 3:
                  {
                     context.globalAlpha = 0.75;
                     context.fillStyle = "#000000";
                     context.beginPath();
                     context.moveTo( px, py + tileSize );
                     context.lineTo( px + Math.sqrt(3) * tileSize, py );
                     context.lineTo( px + Math.sqrt(3) * tileSize, py - 2 * tileSize );
                     context.lineTo( px, py - tileSize );
                  }
                  break;
               default:
                  {
                     throw "Ooops";
                  }
                  break;
            }
            context.closePath();
            context.fill();
            context.globalAlpha = 1.0;
         }

         function getMapCell(y,x,z) {
            if ( z < levelMap.length && z >= 0 && y < levelMap[z].length && y >= 0 && x < levelMap[z][y].length && x >= 0 ) {
               return levelMap[z][y][x];
            }
            return 0;
         }

         function isMapCellVisible(y,x,cy,cx,cz,oy,ox,sx=0.5+ox,sy=0.5+oy,debug=0) {
            var dirY  = y - oy;
            var dirX  = x - ox;
            var dirL  = Math.hypot(dirX,dirY);
            dirY /= dirL;
            dirX /= dirL;

            var celly = cy;
            var cellx = cx;
            var cellz = cz;

            var dist  = 0;
            var arrived = 0;
            var limit = 50;
            var err = 1e-6;
            if ( debug ) {
               console.log( [cy,cx], " -> ", [cy+y,cx+x] ); 
            }

            while ( limit && getMapCell( celly, cellx, cellz ) != 0 && !( celly == cy + y && cellx == cx + x ) ) {
               if ( debug ) {
                  console.log( limit + " - " + celly + ", " + cellx + " [" + sy + ", " + sx + "] dir:" + dirY + ", " + dirX); 
               }

               --limit;
               var jump  = Math.min( Math.max( ( 1 - sx ) / dirX, -sx / dirX ),
                                     Math.max( ( 1 - sy ) / dirY, -sy / dirY ) );
               dist += jump;
               sx = sx + dirX * jump;
               sy = sy + dirY * jump;
               if ( Math.abs(sx) < err && dirX < 0) {
                  sx = 1;
                  cellx -= 1;
                  arrived = 1;
               } else if ( Math.abs(1-sx) < err && dirX > 0 ) {
                  sx = 0;
                  cellx += 1;
                  arrived = 2;
               }
               if ( Math.abs(sy) < err && dirY < 0 ) {
                  sy = 1;
                  celly -= 1;
                  arrived = 3;
               } else if ( Math.abs(1-sy) < err && dirY > 0 ) {
                  sy = 0;
                  celly += 1;
                  arrived = 4;
               }
            }

            if ( debug ) {
               console.log( limit + " - " + celly + ", " + cellx + " [" + sy + ", " + sx + "] dir:" + dirY + ", " + dirX); 
            }
            return ( celly == cy + y && cellx == cx + x );
         }

         function drawCellFloor(y,x,z,cy,cx,oy,ox,tiles) {
            if ( getMapCell(cy+y,cx+x,z) != 5 ) {
               drawFloor(-y+oy,x-ox, "gray");
               var obi = {x:x+cx,y:y+cy,z:z};
               tiles.push(getFloorTile(-y+oy,x-ox,obi));
            }
         }

         function drawCellWall(figurePos,y,x,z,cy,cx,oy,ox,deltaY=0,deltaX=0) {
            if ( !getMapCell(cy+y,cx+x-1,z) ) {
               drawWall(-y+oy+deltaY,x-ox-deltaX,0, "blue");
            }
            if ( !getMapCell(cy+y-1,cx+x,z) ) {
               drawWall(-y+oy+deltaY,x-ox-deltaX,1, "blue");
            }

            var isStairs = getMapCell(cy+y,cx+x,z) == 6;
            var isNorthStairs = isStairs && !getMapCell(cy+y-1,cx+x,z);
            var isSouthStairs = isStairs && !getMapCell(cy+y+1,cx+x,z);

            if ( isNorthStairs ) {
               drawStairs(-y+oy+deltaY,x-ox-deltaX,"gray",0);
            } 

            if ( Math.floor(figurePos[0]+y-cy) == 0 && Math.floor(figurePos[1]+x-cx) == 0 && Math.floor(figurePos[2]-z) == 0 ) {
               if ( isNorthStairs ) {
                  var mag = 0.5-oy;
                  drawItem(-y+mag+deltaY,x-mag-deltaX,"green");
               } else if ( isSouthStairs ) {
                  var mag = 0.5+oy;
                  drawItem(-y+mag+deltaY,x-mag-deltaX,"green");
               } else {
                  drawItem(-y+deltaY,x-deltaX,"green");
               }
            }

            if ( Math.floor(figurePos[0]) == cy+y && Math.floor(figurePos[1]) == cx+x && Math.floor(figurePos[2]) == z - 1 ) {
               var doy = 0.5 - (figurePosition[0]- Math.floor(figurePosition[0]));
               var dox = 0.5 - (figurePosition[1]- Math.floor(figurePosition[1]));
               var isNorthIntern = !getMapCell(cy+y-1,cx+x,z+1);
               var isSouthIntern = !getMapCell(cy+y+1,cx+x,z+1);
               if ( isNorthIntern ) {
                  drawItem(-y+deltaY+doy,x-deltaX-dox,"green", Math.max(0.5+doy,0));
               }
               if ( isSouthIntern ) {
                  drawItem(-y+deltaY+doy,x-deltaX-dox,"green", Math.max(0.5-doy,0));
               }
            }

            if ( isSouthStairs ) {
               drawStairs(-y+oy+deltaY,x-ox-deltaX,"gray",1);
            }

            if ( !getMapCell(cy+y+1,cx+x,z) ) {
               drawWall(-y+oy+deltaY,x-ox-deltaX,2, "blue");
            }
            if ( !getMapCell(cy+y,cx+x+1,z) ) {
               drawWall(-y+oy+deltaY,x-ox-deltaX,3, "blue");
            }
         }


         function drawForeground( camCenter, figurePos, tiles=[], upperLook=1, deltaY = 0, deltaX = 0 ) {
            var cy = Math.floor(camCenter[0]);
            var cx = Math.floor(camCenter[1]);
            var cz = Math.floor(camCenter[2]);
            var oy = camCenter[0] - cy - 0.5;
            var ox = camCenter[1] - cx - 0.5;

            if ( upperLook ) {
               var isStairs = getMapCell(cy,cx,cz) == 6;
               var isNorthStairs = isStairs && !getMapCell(cy-1,cx,cz);
               var isSouthStairs = isStairs && !getMapCell(cy+1,cx,cz);

               if ( isNorthStairs ) {
                  var mag = 0.5-oy;
                  deltaX -= mag;
                  deltaY -= mag;
               } else if ( isSouthStairs ) {
                  var mag = 0.5+oy;
                  deltaX -= mag;
                  deltaY -= mag;
               }
            }

            var cellsy = [];
            var cellsx = [];

            var nextly = [];
            var nextlx = [];

            for ( var y = -10; y < 10; ++y ) {
               for ( var x = -10; x < 10; ++x ) {
                  if ( isMapCellVisible(y,x,cy,cx,cz,oy,ox) 
                       || isMapCellVisible(y,x,cy,cx,cz,oy,ox,0,0) 
                       || isMapCellVisible(y,x,cy,cx,cz,oy,ox,0,1) 
                       || isMapCellVisible(y,x,cy,cx,cz,oy,ox,1,0) 
                       || isMapCellVisible(y,x,cy,cx,cz,oy,ox,1,1) )
                  {
                     var mapval = getMapCell(cy+y,cx+x,cz);
                     if ( mapval ) {
                        cellsy.push(y);
                        cellsx.push(x);
                     }
                     if ( upperLook ) {
                        if ( mapval == 5 && x + y <= 2 ) {
                           drawForeground([cy+y+0.5,cx+x+0.5,cz-1],figurePos,tiles,0,-y-1+oy+deltaY,-x+ox-1+deltaX);
                        }
                        if ( mapval == 6 && x + y <= 2 ) {
                           nextly.push(y);
                           nextlx.push(x);
                        }
                     }
                  }
               }
            }

            {
               for ( var i = 0; i < cellsx.length; ++i ) {
                  drawCellFloor(cellsy[i],cellsx[i],cz,cy,cx,oy+deltaY,ox+deltaX,tiles);
               }
            }

            {
               for ( var i = 0; i < cellsx.length; ++i ) {
                  drawCellWall(figurePos,cellsy[i],cellsx[i],cz,cy,cx,oy,ox,deltaY,deltaX);
               }
            }

            {
               for ( var i = 0; i < nextly.length; ++i ) {
                  var y = nextly[i];
                  var x = nextlx[i];
                  drawForeground([cy+y+0.5,cx+x+0.5,cz+1],figurePos,tiles,0,-y+1+oy+deltaY,-x+ox+1+deltaX);
               }
            }
         }

         function getPointSide(p1,p2,p3) {
            var vx = p2.x - p1.x;
            var vy = p2.y - p1.y;
            var sx = -vy;
            var sy = vx;
            var retval = Math.sign(sx * (p3.x-p1.x) + sy * (p3.y-p1.y));
            return retval;
         }

         function isPointInTriangle(p1,p2,p3,pt) {
            var retval = ( getPointSide(p1,p2,p3) * getPointSide(p1,p2,pt) >= 0 )
                      && ( getPointSide(p2,p3,p1) * getPointSide(p2,p3,pt) >= 0 )
                      && ( getPointSide(p3,p1,p2) * getPointSide(p3,p1,pt) >= 0 );
            return retval;
         }

         function bfs(source,target) {
            if ( !getMapCell(source.y,source.x,source.z) ) {
               return [];
            }
            var hops = {};
            var findings = [[source.y,source.x,source.z]];
            hops[findings[0]]=false;
            var level = 0;
            var dirs = [[0,1],[-1,0],[0,-1],[1,0]];
            while ( level < 10 && findings.length > 0 ) {
               ++level;
               var nfindings = [];
               for ( var i = 0; i < findings.length; ++i ) {
                  for ( var mag = 0; mag <= 1*(getMapCell(findings[i][0],findings[i][1],findings[i][2]) == 6); ++mag ) {
                     for ( var j = 0; j < dirs.length; ++j ) {
                        var nextp = [(findings[i][0]+dirs[j][1]),(findings[i][1]+dirs[j][0]),(findings[i][2])+mag];
                        var mapval = getMapCell(nextp[0],nextp[1],nextp[2]);
                        if ( mapval == 5 ) {
                           --nextp[2];
                        }
                        if ( mapval ) {
                           if ( hops[nextp] === undefined ) {
                              nfindings.push(nextp);
                              hops[nextp] = findings[i];
                           }
                        }
                     }
                  }
               }
               findings = nfindings;
            }
            var tara = [target.y,target.x,target.z];
            var way = [];
            if ( hops[tara] !== undefined ) {
               way.push(tara);
               var maxi = 100;
               while(hops[tara] && maxi ) {
                  way.push(hops[tara]);
                  tara = hops[tara];
                  --maxi;
               }
            }
            way.reverse();
            return way;
         }

         function getCursorsTile(tiles, cx, cy) {
            for ( var i = 0; i < tiles.length; ++i ) {
               if ( isPointInTriangle( tiles[i].p1, tiles[i].p2, tiles[i].p4, {x:cx,y:cy} )
                 || isPointInTriangle( tiles[i].p2, tiles[i].p3, tiles[i].p4, {x:cx,y:cy} ) ) {
                  return tiles[i];
               }
            }
         }

         function moveFigure() {
            if ( figureWay.length == 0 ) {
               return; 
            }

            var ctar = figureWay[0];
           
            if ( getMapCell( Math.floor(figurePosition[0]), Math.floor(figurePosition[1]), figurePosition[2] ) == 5 ) {
               --figurePosition[2];
            }

            for ( var i = 0; i < 2; ++i ) {
               if ( Math.abs(ctar[i] + 0.5 - figurePosition[i]) > 0.1 ) {
                  figurePosition[i] += 0.1 * Math.sign( ctar[i] + 0.5 - figurePosition[i] );
                  if ( Math.abs(ctar[i] + 0.5 - figurePosition[i]) < 0.5 ) {
                     figurePosition[2] = ctar[2];
                  }
                  return;
               } else {
                  figurePosition[i] = ctar[i] + 0.5;
               }
            }

            figurePosition[2] = ctar[2];
            
            figureWay.reverse();
            figureWay.pop();
            figureWay.reverse();
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               var tiles = [];
               drawForeground(figurePosition, figurePosition, tiles);
               drawCursor(curX,curY);
               curTarg = getCursorsTile(tiles,curX,curY);
               drawTile(curTarg, "yellow");
               ANIMATION = requestAnimationFrame(drawScene);
               moveFigure();
            }, 1000 / fps );
         }

         function initCanvas() {

            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         function keyHandlerDown(e) {
           console.log(e.keyCode);
           switch( e.keyCode ) {
              case 37:
                 // left
                 break;
              case 39:
                 // right
                 break;
              case 38:
                 // up
                 break;
              case 40:
                 // up
                 break;
           }
         }

         function keyHandlerUp(e) {
           switch( e.keyCode ) {
              case 37:
                 // left
                 break;
              case 39:
                 // right
                 break;
              case 38:
                 break;
           }
         }


         mainItem.onmousedown = function(event) {
            var way = bfs({x:Math.floor(figurePosition[1]),
                           y:Math.floor(figurePosition[0]),
                           z:Math.floor(figurePosition[2])},
                          curTarg);
            figureWay = way;
         };

         mainItem.onmouseup = function(event) {};

         mainItem.onmousemove = function(event) {
            curX = event.clientX;
            curY = event.clientY;
         };

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
            addEventListener('keydown',keyHandlerDown,false);
            addEventListener('keyup'  ,keyHandlerUp,false);
         })();
      </script>
   </body>
</html>
