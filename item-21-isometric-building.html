<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;

         var fps = 25;
         var ANIMATION;

         var levelMap = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,4,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,4,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,4,0,4,0,0,0,0,1,4,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,0,4,0,1,0,1,0,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,0,1,0,3,0,1,4,1,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,0,0,0,2,0,1,0,1,4,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0],
                         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                         [0,0,1,1,1,1,1,1,4,1,1,4,1,1,1,1,1,1,1,1,4,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                         [0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0],
                         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                         ];

         var cameraCenter = [15.5,15.5];
         var tileSize = 50;

         function drawBackground() {
            context.fillStyle = "black";
            context.fillRect(0,0,screenWidth,screenHeight);
         }

         function drawTile(y,x) {
            context.fillStyle = "blue";
            context.beginPath();
            var px = (x + y) * Math.sqrt(3) * tileSize + screenWidth / 2;
            var py = (x - y) * tileSize + screenHeight / 2;
            context.moveTo( px, py - tileSize );
            context.lineTo( px + Math.sqrt(3) * tileSize, py );
            context.lineTo( px, py + tileSize );
            context.lineTo( px - Math.sqrt(3) * tileSize, py );
            context.closePath();
            context.fill();
         }

         function getMapCell(y,x) {
            if ( y < levelMap.length && y >= 0 && x < levelMap[y].length && x >= 0 ) {
               return levelMap[y][x];
            }
            return 0;
         }

         function isMapCellVisible(y,x,cy,cx,oy,ox,debug=0) {
            var dirY  = y - oy;
            var dirX  = x - ox;
            var dirL  = Math.hypot(dirX,dirY);
            dirY /= dirL;
            dirX /= dirL;

            var celly = cy;
            var cellx = cx;

            var sy    = 0.5 + oy;
            var sx    = 0.5 + ox;
            var dist  = 0;
            var arrived = 0;
            var limit = 10;
            var err = 1e-6;
            if ( debug ) {
               console.log( [cy,cx], " -> ", [cy+y,cx+x] ); 
            }

            while ( limit && getMapCell( celly, cellx ) != 0 && !( celly == cy + y && cellx == cx + x ) ) {
               if ( debug ) {
                  console.log( limit + " - " + celly + ", " + cellx + " [" + sy + ", " + sx + "] dir:" + dirY + ", " + dirX); 
               }

               --limit;
               var jump  = Math.min( Math.max( ( 1 - sx ) / dirX, -sx / dirX ),
                                     Math.max( ( 1 - sy ) / dirY, -sy / dirY ) );
               dist += jump;
               sx = sx + dirX * jump;
               sy = sy + dirY * jump;
               if ( Math.abs(sx) < err && dirX < 0) {
                  sx = 1;
                  cellx -= 1;
                  arrived = 1;
               } else if ( Math.abs(1-sx) < err && dirX > 0 ) {
                  sx = 0;
                  cellx += 1;
                  arrived = 2;
               }
               if ( Math.abs(sy) < err && dirY < 0 ) {
                  sy = 1;
                  celly -= 1;
                  arrived = 3;
               } else if ( Math.abs(1-sy) < err && dirY > 0 ) {
                  sy = 0;
                  celly += 1;
                  arrived = 4;
               }
            }

            if ( debug ) {
               console.log( limit + " - " + celly + ", " + cellx + " [" + sy + ", " + sx + "] dir:" + dirY + ", " + dirX); 
            }
            return ( celly == cy + y && cellx == cx + x );
         }

         function drawFloor(y,x,cy,cx,oy,ox) {
            if ( getMapCell(cy+y,cx+x) && isMapCellVisible(y,x,cy,cx,oy,ox) ) {
               drawTile(-y+oy,x-ox);
            }
         }

         function drawForeground() {
            var cy = Math.floor(cameraCenter[0]);
            var cx = Math.floor(cameraCenter[1]);
            var offy = cameraCenter[0] - cy - 0.5;
            var offx = cameraCenter[1] - cx - 0.5;

            drawFloor(0,0,cy,cx,offy,offx);
            for ( var rad = 1; rad < 10; ++rad ) {
               for ( var pos = -rad; pos < rad; ++pos ) {
                  drawFloor(  rad,  pos,cy,cx,offy,offx);
                  drawFloor(1+pos,  rad,cy,cx,offy,offx);
                  drawFloor(  pos, -rad,cy,cx,offy,offx);
                  drawFloor( -rad,1+pos,cy,cx,offy,offx);
               }
            }
//            cameraCenter[0]+= 0.1;
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               drawForeground();
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / fps );
         }

         function initCanvas() {
            console.log(isMapCellVisible(1,-2,12,15,0,0,1));

            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         function keyHandlerDown(e) {
           console.log(e.keyCode);
           switch( e.keyCode ) {
              case 37:
                 // left
                 cameraCenter[1]-= 0.1;
                 break;
              case 39:
                 // right
                 cameraCenter[1]+= 0.1;
                 break;
              case 38:
                 // up
                 cameraCenter[0]-= 0.1;
                 break;
              case 40:
                 // up
                 cameraCenter[0]+= 0.1;
                 break;
           }
         }

         function keyHandlerUp(e) {
           switch( e.keyCode ) {
              case 37:
                 // left
                 break;
              case 39:
                 // right
                 break;
              case 38:
                 break;
           }
         }

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
            addEventListener('keydown',keyHandlerDown,false);
            addEventListener('keyup'  ,keyHandlerUp,false);
         })();
      </script>
   </body>
</html>
