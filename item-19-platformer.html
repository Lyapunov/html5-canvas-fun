<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;

         var fps = 25;
         var ANIMATION;

         var FALL_ACC = 1;
         var HERO_STEP_X = 2;
         var HERO_STEP_Y = 5;
         var HERO_DELTA = {x:0, y:0};

         var WORLD = [];
         var CAMERA = { x:0, y:0, w: 640, h:480, gap: 100 };

         function GameObject( xywh, movable ) {
            this.xywh = xywh;
            this.v = 0;
            this.movable = movable;
            this.drawOut = function() {
               context.beginPath();
               context.fillStyle = this.movable ? 'blue' : 'green';
               context.rect(this.xywh.x - CAMERA.x, this.xywh.y - CAMERA.y, this.xywh.w, this.xywh.h);
               context.fill();
            }
            this.ground = 0;
            this.clearGroundBit = function() {
               if ( this.ground ) {
                  console.log('clearGroundBit');
                  this.ground = 0;
               }
            }
            this.setToGround = function( posY ) {
               if ( this.v >= 0 ) {
                  if ( !this.ground ) {
                     console.log('setGroundBit');
                     this.ground = 1;
                  }

                  // lock
                  this.xywh.y = posY;
                  this.v = 0;
               }
            }
            this.getGroundBit = function() {
               return this.ground;
            }
            this.jump = function() {
               if ( this.ground ) {
                  this.clearGroundBit();
                  this.v = -10;
               }
            }
            this.move = function() {
               if ( this.movable ) {
                  this.xywh.y += this.v;
                  if ( this.v < 100 ) {
                     console.log('moveit ' + this.v);
                     this.v += FALL_ACC;
                  }
               }
            }
            this.commonX = function( other ) {
               return Math.floor( ( this.xywh.w + other.xywh.w ) / 2 ) - Math.abs(this.xywh.x - other.xywh.x);
            }
            this.commonY = function( other ) {
               return Math.floor( ( this.xywh.w + other.xywh.y ) / 2 ) - Math.abs(this.xywh.y - other.xywh.y);
            }
            this.hit = function( other ) {
               var cx = this.commonX( other );
               var cy = this.commonY( other );
               if ( cx > 0 && cy > 0 ) {
                  if ( cx >= cy ) {
                     return +1;
                  } else {
                     return -1;
                  }
               }
               return 0;
            }
         }

         var hero = new GameObject( {x:30, y:10, w:64, h:128}, 1 );

         function createWorld() {
            WORLD.push( hero );
            WORLD.push( new GameObject( {x:10, y:200, w:64, h:64}, 0 ) );
            WORLD.push( new GameObject( {x:74, y:232, w:64, h:64}, 0 ) );
            WORLD.sort( function(a,b) { return a.xywh.x > b.xywh.x; } );

            // Setting first and last object on camera picture
            CAMERA.first = WORLD.length;
            for ( var i = 0; i < WORLD.length; ++i ) {
               if ( WORLD[i].xywh.x >= CAMERA.x - CAMERA.gap ) {
                  CAMERA.first = i;
                  break;
               }
            }
            CAMERA.last = WORLD.length;
            for ( var i = 0; i < WORLD.length; ++i ) {
               if ( WORLD[i].xywh.x > CAMERA.x + CAMERA.w + CAMERA.gap ) {
                  CAMERA.last = i;
                  break;
               }
            }
         }

         function hitCorrection( i ) {
            if ( WORLD[i].movable ) {
               var clearBit = 1;
               for ( var j = CAMERA.first; j < CAMERA.last; ++j ) {
                  if ( !WORLD[j].movable ) {
                     var hit = WORLD[i].hit( WORLD[j] );
                     if ( hit ) {
                        if ( hit > 0 ) {
                           // X is dominant, correcting Y
                           if ( WORLD[i].xywh.y < WORLD[j].xywh.y +  WORLD[j].xywh.h / 2 ) {
                              WORLD[i].setToGround( WORLD[j].xywh.y - WORLD[i].xywh.h );
                              clearBit = 0;
                           } else {
                              WORLD[i].xywh.y = WORLD[j].xywh.y + WORLD[j].xywh.h;
                           }
                        } else {
                           // Y is dominant, correcting X
                           if ( WORLD[i].xywh.x < WORLD[j].xywh.x ) {
                              WORLD[i].xywh.x = WORLD[j].xywh.x - WORLD[i].xywh.w;
                           } else {
                              WORLD[i].xywh.x = WORLD[j].xywh.x + WORLD[j].xywh.w;
                           }
                        }
                        break;
                     }
                  }
               }
               if ( clearBit ) {
                  WORLD[i].clearGroundBit();
               }
            }
         }

         function drawBackground() {
            context.fillStyle = "black";
            context.fillRect(0,0,screenWidth,screenHeight);
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               for ( var i = CAMERA.first; i < CAMERA.last; ++i ) {
                  WORLD[i].drawOut();
               }
               for ( var i = CAMERA.first; i < CAMERA.last; ++i ) {
                  WORLD[i].move();
               }
               hero.xywh.x += HERO_DELTA.x;
               hero.xywh.y += HERO_DELTA.y;
               HERO_DELTA = {x:0,y:0};
               for ( var i = CAMERA.first; i < CAMERA.last; ++i ) {
                  hitCorrection(i);
               }
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / fps );
         }

         function keyHandler(e) {
           switch( e.keyCode ) {
              case 65:
                 // A
                 HERO_DELTA = {x: -HERO_STEP_X, y:0};
                 break;
              case 68:
                 // D
                 HERO_DELTA = {x: +HERO_STEP_X, y:0};
                 break;
              case 69:
                 break;
              case 81:
                 break;
              case 83:
                 // S
                 break;
              case 87:
                 // W
                 console.log('jump');
                 hero.jump();
                 break;
           }
         }

         function initCanvas() {
            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         //init
         (function() {
            createWorld();
            initCanvas();
            addEventListener('resize', initCanvas, false);
            addEventListener('keydown',keyHandler,false);
         })();
      </script>
   </body>
</html>
