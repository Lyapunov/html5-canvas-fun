<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500">
      Your browser doesn't support html5 canvas.
      </canvas>
      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');

         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var screenScale  = Math.min( screenWidth, screenHeight ) / 2;

         var fps = 10;
         var ANIMATION;

         function drawBackground() {
            context.fillStyle = "black";
            context.fillRect(0,0,screenWidth,screenHeight);
         }

         var uenvironment = [ [0,0,0,1,1,1,0],
                              [1,0,0,0,1,1,0],
                              [1,0,0,0,0,1,0],
                              [1,0,0,0,0,0,0],
                              [1,0,0,0,0,0,1],
                              [1,0,1,0,0,0,1],
                              [1,0,0,1,1,0,1] ];
         var fieldOfView = Math.PI / 2;
         var wallHeight   = 1.0; 

         var ux = 0.3;
         var uy = 0.3;
         var uang = 0.4;
         var err = 0.00001;

         function generateRayCastingImage( rx, ry, rang, environment ) {
            var dim  = environment.length;
            var half = Math.floor( ( dim - 1 ) / 2 );
            var cx = half;
            var cy = half;
            var step = fieldOfView / screenWidth;
            var dirAngl = rang - fieldOfView / 2;
            for ( var i = 0; i < screenWidth; ++i ) {
               dirAngl   += step; 

               var dirX  = Math.cos( dirAngl );
               var dirY  = Math.sin( dirAngl );
               var cellx = cx;
               var celly = cy;
               var sx    = rx;
               var sy    = ry;
               var valid = 1;
               var dist = 0;

               do {
                  var jump  = Math.min( Math.max( ( 1 - sx ) / dirX, -sx / dirX ),
                                        Math.max( ( 1 - sy ) / dirY, -sy / dirY ) );
                  dist += jump;
                  var nx    = rx + dirX * jump;
                  var ny    = ry + dirY * jump;
                  if ( Math.abs(nx) < err ) {
                     nx = 1;
                     cellx -= 1;
                     if ( cellx < 0 ) {
                        valid = false;
                     }
                  } else if ( Math.abs(1-nx) < err ) {
                     nx = 0;
                     cellx += 1;
                     if ( cellx > dim ) {
                        valid = false;
                     }
                  } else if ( Math.abs(ny) < err ) {
                     ny = 1;
                     celly -= 1;
                     if ( celly < 0 ) {
                        valid = false;
                     }
                  } else if ( Math.abs(1-ny) < err ) {
                     ny = 0;
                     celly += 1;
                     if ( celly > dim ) {
                        valid = false;
                     }
                  } else {
                     throw new Error( "Impossible branch!" );
                  }
               } while ( valid && environment[cellx][celly] == 0 );

               if ( valid ) {
                  context.fillStyle = "yellow";
                  var reli = screenScale * wallHeight / dist;
                  context.fillRect(i, screenHeight / 2 - reli, 1, 2 * reli);
               }
            }
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               generateRayCastingImage( ux, uy, uang, uenvironment )
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / fps );
         }

         function initCanvas() {
            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;
            screenScale  = Math.min( screenWidth, screenHeight ) / 2;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
         })();
      </script>
   </body>
</html>
