<!DOCTYPE HTML>
<html>
   <head>
      <style>
         body {
            margin : 0px;
            padding: 0px;
         }
      </style>
   </head>
   <body>
   	<canvas id="canvas" width="500" height="500"></canvas>

      <script>
         var mainItem     = document.getElementById('canvas');
         var context      = mainItem.getContext('2d');
         var screenWidth  = mainItem.width  = window.innerWidth  - 20;
         var screenHeight = mainItem.height = window.innerHeight - 20;
         var ANIMATION;  // ??

         var eyedist = 2.5;
         var roadWidth = 2000;
         var segmentLength = 800;
         var numberOfQuads = 200;
         var pos = 0;
         var camHeight = 1500;


         function roadProjection( vertex, cam ) {
            if ( cam[2] > vertex[2] ) {
               return;
            }
            scale = eyedist / ( vertex[2] - cam[2] );
            sx = (cam[0]-vertex[0]) * scale; 
            sy = (cam[1]-vertex[1]) * scale; 
            sr = roadWidth * scale;
            return [ sx * screenHeight / 2, sy * screenHeight / 2, sr * screenHeight / 2 ];
         }

         function create3D( ax, az ) {
            return [ ax, -2 + Math.cos(ax / 2) / 2 + Math.cos(az / 2) / 2, az  ];
         }

         function drawQuad( color, triplet1, triplet2, roadScale ) { // triplet is [x,w,y]
            context.fillStyle = color;
            context.beginPath();
            context.moveTo( Math.floor(triplet1[0]-triplet1[2]*roadScale+screenWidth/2), Math.floor(triplet1[1]+screenHeight/2) );
            context.lineTo( Math.floor(triplet2[0]-triplet2[2]*roadScale+screenWidth/2), Math.floor(triplet2[1]+screenHeight/2) );
            context.lineTo( Math.floor(triplet2[0]+triplet2[2]*roadScale+screenWidth/2), Math.floor(triplet2[1]+screenHeight/2) );
            context.lineTo( Math.floor(triplet1[0]+triplet1[2]*roadScale+screenWidth/2), Math.floor(triplet1[1]+screenHeight/2) );
            context.closePath();
            context.fill();
         }

         function getSegmentCurve( i ) {
            if ( i < 100 ) {
               return 5;
            }
            if ( i < 200 ) {
               return -5;
            }
            return 0;
         }

         function getSegmentY(i) {
            if ( i > 200 ) {
               return Math.sin(Math.PI*i/50.0)*1500;
            }
            return 0;
         }
         
         function getSegmentTriplet( i, xx, yy ) {
            return roadProjection( [xx,getSegmentY(i),segmentLength*i], [0, camHeight+yy, pos] );
         }

         function Plane(color1, color2) {
            this.color1 = color1;
            this.color2 = color2;
            this.draw  = function() {

               var startPos = Math.floor(pos / segmentLength);
               var xx = 0;
               var yy = getSegmentY(startPos);
               var dx = 0;
               for ( var i = startPos; i <= startPos + numberOfQuads; i++ ) {
                  xx += dx;
                  dx += getSegmentCurve(i);
               }
               for ( var i = startPos + numberOfQuads; i > startPos; i-- ) {
                  var t2 = getSegmentTriplet(i, xx, yy);
                  dx -= getSegmentCurve(i);
                  xx -= dx;
                  var t1 = getSegmentTriplet(i-1, xx, yy);
                  if ( t1 && t2 ) {
                     drawQuad( Math.floor(i/3)%2?'forestgreen':'darkgreen', [0,t1[1],screenWidth/2], [0,t2[1],screenWidth/2], 1.0 );
                     drawQuad( Math.floor(i/3)%2?'white':'black'     , t1, t2, 1.2 );
                     drawQuad( Math.floor(i/3)%2?'grey':'dimgrey'   , t1, t2, 1.0 );
                  }
               }
            };
         }

         var plane = new Plane('green', 'lightgreen');

         function drawBackground() {
            context.fillStyle = "lightblue";
            context.fillRect(0,0,screenWidth,screenHeight);
         }

         function moving() {
            pos+=300;
         }

         // common functions 
         function drawScene() {
            setTimeout( function() {
               drawBackground();
               plane.draw();
               moving();
               ANIMATION = requestAnimationFrame(drawScene);
            }, 1000 / 50);
         }

         function initCanvas() {
            var style = getComputedStyle(mainItem);
            screenWidth  = mainItem.width  = window.innerWidth  - 20;
            screenHeight = mainItem.height = window.innerHeight - 20;

            // starting the engine only if it is not running
            if ( !ANIMATION ) {
               drawScene();
            }
         }

         //init
         (function() {
            initCanvas();
            addEventListener('resize', initCanvas, false);
         })();
      </script>
   </body>
</html>
